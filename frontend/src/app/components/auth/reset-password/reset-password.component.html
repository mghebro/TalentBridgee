<div class="auth-card" *ngIf="token; else invalidLink">
  <ng-container *ngIf="!resetCompleted; else successView">
    <h2>Set a new password</h2>
    <p class="subtitle">Choose a strong password you haven't used before for this account.</p>

    <form nz-form [formGroup]="form" (ngSubmit)="submit()">
      <nz-form-item>
        <nz-form-control
          [nzValidateStatus]="
            newPasswordControl?.invalid && newPasswordControl?.touched ? 'error' : ''
          "
          [nzErrorTip]="passwordErrorTpl"
        >
          <nz-input-group nzPrefixIcon="lock">
            <input
              nz-input
              placeholder="New password"
              type="password"
              formControlName="newPassword"
              autocomplete="new-password"
            />
          </nz-input-group>
        </nz-form-control>
        <ng-template #passwordErrorTpl>
          <span *ngIf="newPasswordControl?.errors?.['required']">Password is required.</span>
          <span *ngIf="newPasswordControl?.errors?.['minlength']">
            Password must be at least 8 characters.
          </span>
          <span *ngIf="newPasswordControl?.errors?.['pattern']">
            Include uppercase, lowercase, number, and special character.
          </span>
        </ng-template>
      </nz-form-item>

      <nz-form-item>
        <nz-form-control
          [nzValidateStatus]="
            (passwordsDoNotMatch || confirmPasswordControl?.invalid) &&
            confirmPasswordControl?.touched
              ? 'error'
              : ''
          "
          [nzErrorTip]="confirmErrorTpl"
        >
          <nz-input-group nzPrefixIcon="lock">
            <input
              nz-input
              placeholder="Confirm password"
              type="password"
              formControlName="confirmPassword"
              autocomplete="new-password"
            />
          </nz-input-group>
        </nz-form-control>
        <ng-template #confirmErrorTpl>
          <span *ngIf="confirmPasswordControl?.errors?.['required']">Confirm your password.</span>
          <span *ngIf="passwordsDoNotMatch">Passwords do not match.</span>
        </ng-template>
      </nz-form-item>

      <button
        nz-button
        nzType="primary"
        nzBlock
        [disabled]="form.invalid || passwordsDoNotMatch"
        [nzLoading]="isLoading"
      >
        Reset password
      </button>
    </form>
  </ng-container>
</div>

<ng-template #successView>
  <nz-result
    nzStatus="success"
    nzTitle="Password updated"
    nzSubTitle="Your password was reset successfully. Use it the next time you log in."
  >
    <div nz-result-extra>
      <button nz-button nzType="primary" (click)="goToLogin()">Back to login</button>
    </div>
  </nz-result>
</ng-template>

<ng-template #invalidLink>
  <div class="auth-card">
    <nz-result
      nzStatus="warning"
      nzTitle="Invalid reset link"
      nzSubTitle="The password reset link is invalid or has expired."
    >
      <div nz-result-extra>
        <a nz-button nzType="primary" routerLink="/auth/forgot-password">Request new link</a>
      </div>
    </nz-result>
  </div>
</ng-template>
